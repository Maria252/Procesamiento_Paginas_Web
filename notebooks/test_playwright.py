#!/usr/bin/env python3
"""
Script de verificaci√≥n espec√≠fico para Playwright en MyBinder.
Ejecuta este script para verificar que Playwright est√© funcionando correctamente.
"""

import sys
import subprocess
import asyncio
from playwright.async_api import async_playwright

async def test_playwright():
    """Test b√°sico de Playwright"""
    print("üåê Probando Playwright...")
    
    try:
        async with async_playwright() as p:
            print("   ‚úÖ Playwright importado correctamente")
            
            # Intentar lanzar navegador
            browser = await p.chromium.launch(headless=True)
            print("   ‚úÖ Chromium lanzado exitosamente")
            
            # Crear p√°gina de prueba
            page = await browser.new_page()
            print("   ‚úÖ P√°gina creada exitosamente")
            
            # Navegar a una p√°gina simple
            await page.goto('https://example.com')
            print("   ‚úÖ Navegaci√≥n exitosa")
            
            # Obtener t√≠tulo
            title = await page.title()
            print(f"   ‚úÖ T√≠tulo obtenido: {title}")
            
            await browser.close()
            print("   ‚úÖ Navegador cerrado correctamente")
            
        return True
        
    except Exception as e:
        print(f"   ‚ùå Error en Playwright: {e}")
        return False

def check_system_dependencies():
    """Verificar dependencias del sistema"""
    print("üîç Verificando dependencias del sistema...")
    
    dependencies = [
        'libnspr4', 'libnss3', 'libdbus-1-3', 'libatk1.0-0',
        'libatk-bridge2.0-0', 'libatspi2.0-0', 'libxcomposite1',
        'libxdamage1', 'libxfixes3', 'libxrandr2', 'libgbm1',
        'libxkbcommon0', 'libasound2'
    ]
    
    missing = []
    for dep in dependencies:
        try:
            result = subprocess.run(['dpkg', '-l', dep], 
                                 capture_output=True, text=True)
            if result.returncode != 0:
                missing.append(dep)
        except:
            missing.append(dep)
    
    if missing:
        print(f"   ‚ùå Faltan dependencias: {', '.join(missing)}")
        return False
    else:
        print("   ‚úÖ Todas las dependencias del sistema est√°n instaladas")
        return True

async def main():
    """Funci√≥n principal"""
    print("üîç Verificaci√≥n de Playwright para MyBinder")
    print("=" * 50)
    
    # Verificar dependencias del sistema
    sys_deps_ok = check_system_dependencies()
    
    # Verificar Playwright
    playwright_ok = await test_playwright()
    
    print("\n" + "=" * 50)
    if sys_deps_ok and playwright_ok:
        print("üéâ ¬°Playwright est√° funcionando correctamente!")
        print("\nüìù Pr√≥ximos pasos:")
        print("   1. Ejecuta: python 0_html_processing.py")
        print("   2. El script deber√≠a funcionar sin errores de navegador")
    else:
        print("‚ùå Hay problemas con Playwright")
        print("\nüîß Soluciones:")
        if not sys_deps_ok:
            print("   1. Las dependencias del sistema faltan")
            print("   2. Esto deber√≠a solucionarse autom√°ticamente en MyBinder")
            print("   3. Si persiste, reporta el problema en el repositorio")
        if not playwright_ok:
            print("   4. Hay un problema con la instalaci√≥n de Playwright")
            print("   5. Intenta ejecutar: python -m playwright install chromium")
    
    return sys_deps_ok and playwright_ok

if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
